<!doctype html>
<html>
  <head>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
    <meta charset="utf-8">
    <title>Platformer</title>
    <style>
      * {
      margin: 0;
      padding: 0;
      }
      body{
        overflow:hidden;
      }
      #field {
      text-align:center;
      }
      #game {
        border: 2px solid black;
      }
    </style>
  </head>
  <body>
    <h1 id="debug"></h1>
    <div id="field">
      <canvas id="game"></canvas>
    </div>
    
    <div style="display:none">
      <img id="BG" src="http://chimpsterman.github.io/pics/platformer/BG/BG.png">
    </div>
    <script>
      $(function(){
        var socket = io();
        var canvas = document.getElementById('game');
        var background = document.getElementById('BG');
        canvas.height = window.innerHeight;
        canvas.width = (window.innerHeight/3)*4;
        var ctx = canvas.getContext("2d");
        var standardH = 605, standardW = 806;
        var lobby, color, name, x, y, vX = 0, vY = 0;
        var speed = 2, pW = 40, pH = 80;
        var toDraw = [];
        var jump, jumping = false;
        
        
        socket.on('connect', function(){
          name = prompt('Please Enter a Username');
          socket.emit('newconnection', name);
        });
        
        socket.on('setup', function(c){
          color = c;
          x = (standardW/2)-(pW/2);
          y = ((standardH/15) * 13)-(pH/2);
          lobby = setInterval(lobbySequence, 10);
        });
        
        socket.on('disconnection', function(user){
          var temp = null;
          for (var i = 0; i < toDraw.length; i++){
            if (toDraw[i].name == user){
              temp = i;
              break;
            }
          }
          if (temp != null){
            toDraw.splice(temp,1);
          }
        });
        
        socket.on('newMove', function(n, c, X, Y){
          var temp = null;
          for (var i = 0; i < toDraw.length; i++){
            if (toDraw[i].name == n){
              temp = i;
              break;
            }
          }
          if (temp != null){
            toDraw[temp] = {name:n, color:c, x:X, y:Y};
          } else {
            toDraw.push({name:n, color:c, x:X, y:Y});
          }
        });
        
        function lobbySequence(){
          movement('lobby');
          
          draw();
        }
        
        function draw(){
          ctx.drawImage(background,0,0,canvas.width,canvas.height);
          for (var i = 0; i < toDraw.length; i++){
            ctx.fillStyle = toDraw[i].color;
            ctx.fillRect(scaleX(toDraw[i].x),scaleY(toDraw[i].y),scaleX(pW),scaleY(pH));
            //ctx.fillRect(toDraw[i].x,toDraw[i].y,pW,pH);
          }
        }
        
        function move(key){
          if (key == "UP"){
            if (!jumping){
              jumping = true;
              vY -= 10;
            }
          }
          if (key == "RIGHT"){
            if (vX < speed){
              vX += speed;
            }
          }
          if (key == "DOWN"){
            
          }
          if (key == "LEFT"){
            if (vX > -speed){
              vX -= speed;
            }
          }
        }
        
        function movement(room){
          x += vX;
          y += vY;
          vX *= .8;
          vY += .25;
          if (y+pH > (standardH/15) * 14){
            jumping = false;
            y = ((standardH/15) * 14)-(pH);
            vY = 0;
          }
          socket.emit('move', room, name, color, x, y);
        }
        
      var keyState = {};  
      setInterval(keyLoop, 10);
      window.addEventListener('keydown',function(e){
        keyState[e.keyCode || e.which] = true;
      },true);    
      window.addEventListener('keyup',function(e){
        keyState[e.keyCode || e.which] = false;
      },true);
      
      function keyLoop() {
        if (keyState[37]){
          move("LEFT");
        } 
        if (keyState[38]){
          move("UP");
        } 
        if (keyState[39]){
          move("RIGHT");
        }
        if (keyState[40]){
          move("DOWN");
        } 
      }  
        
      //utilities
      function scaleX(num){
        return canvas.width/(standardW/num);
      }
        
      function scaleY(num){
        return canvas.height/(standardH/num);
      }
        
      });
    </script>
  </body>
</html>